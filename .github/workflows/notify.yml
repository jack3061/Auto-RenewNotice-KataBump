name: Katabump Notify

on:
  schedule:
    # å»ºè®®è®¾ç½®ï¼šæ¯ 3 å¤©çš„åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00 è¿è¡Œ
    # (GitHub æ˜¯ UTC æ—¶é—´ï¼ŒUTC 1:00 = åŒ—äº¬ 9:00)
    - cron: '0 1 */3 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨æµ‹è¯•

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests

      - name: Send Notification
        env:
          # å¿…é¡»åœ¨ä»“åº“ Settings -> Secrets é‡Œé…ç½®è¿™ä¸¤ä¸ª
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          # å¯é€‰é…ç½® KB_USER æ˜¾ç¤ºè´¦å·å
          KB_USER: ${{ secrets.KB_USER }}
        shell: python
        run: |
          import requests
          import os
          import datetime
          import time

          # --- 1. è·å–å½“å‰åŒ—äº¬æ—¶é—´ ---
          utc_now = datetime.datetime.utcnow()
          beijing_time = utc_now + datetime.timedelta(hours=8)
          fmt_time = beijing_time.strftime("%Y-%m-%d %H:%M:%S")
          
          # --- 2. è·å–é…ç½® ---
          token = os.environ.get("TG_BOT_TOKEN")
          chat_id = os.environ.get("TG_CHAT_ID")
          user = os.environ.get("KB_USER", "é»˜è®¤è´¦å·")

          # ç®€å•çš„è´¦å·è„±æ•å¤„ç†
          if "@" in user and len(user) > 3:
              parts = user.split("@")
              masked_user = parts[0][:3] + "***@" + parts[1]
          else:
              masked_user = user

          if not token or not chat_id:
              print("âŒ é”™è¯¯: Secrets æœªé…ç½®ï¼Œæ— æ³•å‘é€é€šçŸ¥")
              exit(1)

          # --- 3. æ„å»ºæ¶ˆæ¯å†…å®¹ (åŒ…å«è¯¦ç»† Renew æ­¥éª¤) ---
          text = f"""
          ğŸš¨ <b>Katabump ç»­æœŸæé†’</b>
          
          ğŸ“… <b>æ—¶é—´:</b> {fmt_time}
          ğŸ‘¤ <b>è´¦å·:</b> <code>{masked_user}</code>
          
          âš ï¸ <b>çŠ¶æ€æç¤º:</b>
          æœåŠ¡å™¨å‘¨æœŸå·²è¿‡ 3 å¤©ï¼Œè¯·åŠ¡å¿…åœ¨ 24 å°æ—¶å†…æ“ä½œç»­æœŸã€‚
          
          ğŸ“ <b>Renew æ“ä½œæŒ‡å—:</b>
          1. ç™»å½• <a href="https://dashboard.katabump.com/">Dashboard</a>
          2. ç‚¹å‡»èœå•æ  <b>Your Servers</b>
          3. æ‰¾åˆ°æœåŠ¡å™¨ç‚¹å‡» <b>See</b>
          4. è¿›å…¥ <b>General</b> é¡µé¢
          5. ç‚¹å‡»è“è‰²çš„ <b>Renew</b> æŒ‰é’®
          
          ğŸ”— <a href="https://dashboard.katabump.com/">ç‚¹å‡»æ­¤å¤„ç›´æ¥è·³è½¬ç™»å½•</a>
          """

          # --- 4. å‘é€è¯·æ±‚ ---
          url = f"https://api.telegram.org/bot{token}/sendMessage"
          data = {
              "chat_id": chat_id, 
              "text": text, 
              "parse_mode": "HTML",
              "disable_web_page_preview": True
          }

          print(">>> æ­£åœ¨å‘é€é€šçŸ¥...")
          try:
              resp = requests.post(url, json=data, timeout=15)
              if resp.status_code == 200:
                  print("âœ… é€šçŸ¥å‘é€æˆåŠŸï¼")
              else:
                  print(f"âš ï¸ å‘é€å¤±è´¥: {resp.text}")
                  exit(1) # æ ‡è®°ä¸ºå¤±è´¥
          except Exception as e:
              print(f"âŒ ç½‘ç»œé”™è¯¯: {e}")
              exit(1)
